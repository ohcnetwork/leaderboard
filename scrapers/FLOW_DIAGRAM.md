# Update Roles and Slack - Flow Diagram

## High-Level Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                     Start: pnpm update-roles                    │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│              Connect to PGlite Database (db-data)               │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│           SELECT * FROM contributor (Get all users)             │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                  For Each Contributor (Loop)                    │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│  Fetch: https://raw.githubusercontent.com/ohcnetwork/          │
│         leaderboard-data/.../contributors/{username}.md        │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                ┌─────────┴─────────┐
                │                   │
                ▼                   ▼
        ┌──────────────┐    ┌──────────────┐
        │   404 Error  │    │   Success    │
        │  (Not Found) │    │  (Got .md)   │
        └──────┬───────┘    └──────┬───────┘
               │                   │
               │                   ▼
               │    ┌─────────────────────────────────┐
               │    │  Extract Frontmatter Data:      │
               │    │  - role: string | null          │
               │    │  - slack: string | null         │
               │    └──────┬──────────────────────────┘
               │           │
               │           ▼
               │    ┌─────────────────────────────────┐
               │    │  Both null?                     │
               │    └──────┬──────────────────────────┘
               │           │
               │    ┌──────┴──────┐
               │    │             │
               │    ▼             ▼
               │  ┌────┐      ┌──────────────────┐
               │  │Skip│      │  Update Database │
               │  └─┬──┘      └────────┬─────────┘
               │    │                  │
               │    │                  ▼
               │    │         ┌────────────────────┐
               │    │         │ Conditional Update:│
               │    │         │ - Both? Update both│
               │    │         │ - Role? Update role│
               │    │         │ - Slack? Update    │
               │    │         │   meta.slack_user_id│
               │    │         └────────┬───────────┘
               │    │                  │
               └────┼──────────────────┘
                    │
                    ▼
         ┌──────────────────────┐
         │  Log Result & Stats  │
         └──────────┬───────────┘
                    │
                    ▼
         ┌──────────────────────┐
         │    Next Contributor  │
         └──────────┬───────────┘
                    │
                    ▼
         ┌──────────────────────┐
         │   All Done? Print    │
         │   Summary Statistics │
         └──────────────────────┘
```

## Data Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                     Markdown File (GitHub)                      │
│                                                                 │
│  ---                                                            │
│  name: Rahul                                                    │
│  role: contributor          ◄─── Extract this                  │
│  slack: U12345ABC           ◄─── Extract this                  │
│  ---                                                            │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                   extractFrontmatterData()                      │
│                                                                 │
│  Returns: { role: "contributor", slack: "U12345ABC" }          │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                     updateContributor()                         │
│                                                                 │
│  Decides which SQL query to run based on available data        │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Database (PGlite)                            │
│                                                                 │
│  contributor table:                                             │
│  ┌──────────────┬──────────────┬─────────────────────────┐    │
│  │ username     │ role         │ meta                    │    │
│  ├──────────────┼──────────────┼─────────────────────────┤    │
│  │ 07Akashh     │ contributor  │ {"slack_user_id":       │    │
│  │              │              │  "U12345ABC"}           │    │
│  └──────────────┴──────────────┴─────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

## Update Logic Decision Tree

```
                    ┌─────────────────┐
                    │  Have role and  │
                    │     slack?      │
                    └────────┬────────┘
                             │
              ┌──────────────┼──────────────┐
              │              │              │
              ▼              ▼              ▼
         ┌────────┐     ┌────────┐    ┌────────┐
         │  Both  │     │  Only  │    │  Only  │
         │        │     │  role  │    │  slack │
         └───┬────┘     └───┬────┘    └───┬────┘
             │              │              │
             ▼              ▼              ▼
    ┌────────────────┐ ┌──────────┐ ┌──────────────┐
    │ UPDATE         │ │ UPDATE   │ │ UPDATE       │
    │ contributor    │ │ contrib. │ │ contributor  │
    │ SET role=$1,   │ │ SET      │ │ SET meta=    │
    │ meta=meta||$2  │ │ role=$1  │ │ meta||$1     │
    └────────────────┘ └──────────┘ └──────────────┘
```

## Error Handling Flow

```
                    ┌─────────────────┐
                    │  Try to fetch   │
                    │    markdown     │
                    └────────┬────────┘
                             │
              ┌──────────────┼──────────────┐
              │              │              │
              ▼              ▼              ▼
         ┌────────┐     ┌────────┐    ┌────────┐
         │ 404    │     │ Network│    │Success │
         │ Error  │     │ Error  │    │        │
         └───┬────┘     └───┬────┘    └───┬────┘
             │              │              │
             ▼              ▼              │
    ┌────────────────┐ ┌──────────┐      │
    │ Log warning    │ │ Log error│      │
    │ notFoundCount++│ │errorCount│      │
    │ Continue       │ │ Continue │      │
    └────────────────┘ └──────────┘      │
                                          ▼
                                   ┌──────────────┐
                                   │ Extract data │
                                   └──────┬───────┘
                                          │
                                   ┌──────┴───────┐
                                   │              │
                                   ▼              ▼
                              ┌────────┐    ┌────────┐
                              │No data │    │Has data│
                              └───┬────┘    └───┬────┘
                                  │             │
                                  ▼             ▼
                         ┌────────────┐  ┌──────────┐
                         │ Log warn   │  │  Update  │
                         │noDataCount │  │   DB     │
                         │ Continue   │  │success++ │
                         └────────────┘  └──────────┘
```

## Test Coverage

```
┌─────────────────────────────────────────────────────────────────┐
│                        Test Scenarios                           │
├─────────────────────────────────────────────────────────────────┤
│  ✅ Extract role and slack from valid frontmatter              │
│  ✅ Extract with double quotes                                 │
│  ✅ Extract with single quotes                                 │
│  ✅ Handle no frontmatter                                      │
│  ✅ Handle missing fields                                      │
│  ✅ Handle empty slack as null                                 │
│  ✅ Handle extra whitespace                                    │
│  ✅ Handle different role values                               │
│  ✅ Handle only role without slack                             │
│  ✅ Handle only slack without role                             │
└─────────────────────────────────────────────────────────────────┘
```

