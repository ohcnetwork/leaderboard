---
title: API Reference
description: Complete API and schema reference
---

# API Reference

Complete reference for the OHC Leaderboard's configuration schema and database structure.

## Configuration Schema

The complete configuration schema is available in `config.schema.json`. Use it for:

- IDE autocomplete and validation
- Programmatic config generation
- Documentation of all options

### Schema Reference

Add to the top of your `config.yaml`:

```yaml
# yaml-language-server: $schema=config.schema.json
```

This enables IDE features like:
- Autocomplete for configuration keys
- Real-time validation
- Inline documentation
- Type checking

## Database Schema

The database schema is defined in `lib/db.ts`. The leaderboard uses PGlite (PostgreSQL) for data storage.

### Contributors Table

Stores user profiles and metadata.

**Columns:**

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| `username` | VARCHAR(255) | No | Unique username (Primary Key) |
| `name` | VARCHAR(255) | No | Display name |
| `avatar_url` | TEXT | Yes | Profile picture URL |
| `role` | VARCHAR(50) | No | User role identifier |
| `socials` | JSONB | Yes | Social media links |
| `created_at` | TIMESTAMP | No | Account creation time |
| `updated_at` | TIMESTAMP | No | Last update time |

**Indexes:**
- Primary key on `username`
- Index on `role`
- Index on `created_at`

**Example:**

```sql
SELECT * FROM contributors WHERE role = 'core' ORDER BY created_at DESC;
```

### Activities Table

Stores individual contribution events.

**Columns:**

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| `id` | VARCHAR(255) | No | Unique activity ID (Primary Key) |
| `username` | VARCHAR(255) | No | Contributor username (Foreign Key) |
| `activity_type` | VARCHAR(100) | No | Type of activity |
| `timestamp` | TIMESTAMP | No | When activity occurred |
| `points` | INTEGER | No | Points earned |
| `metadata` | JSONB | Yes | Additional activity data |
| `created_at` | TIMESTAMP | No | Record creation time |

**Indexes:**
- Primary key on `id`
- Index on `username`
- Index on `activity_type`
- Index on `timestamp`
- Composite index on `(username, timestamp)`

**Example:**

```sql
SELECT 
  activity_type,
  COUNT(*) as count,
  SUM(points) as total_points
FROM activities
WHERE username = 'johndoe'
  AND timestamp >= NOW() - INTERVAL '7 days'
GROUP BY activity_type;
```

### Aggregates Table

Stores pre-calculated statistics.

**Columns:**

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| `id` | SERIAL | No | Auto-increment ID (Primary Key) |
| `type` | VARCHAR(50) | No | Aggregate type (global/contributor) |
| `key` | VARCHAR(100) | No | Aggregate key |
| `value` | NUMERIC | No | Aggregate value |
| `metadata` | JSONB | Yes | Additional aggregate data |
| `updated_at` | TIMESTAMP | No | Last update time |

**Indexes:**
- Primary key on `id`
- Unique index on `(type, key)`
- Index on `updated_at`

**Example:**

```sql
SELECT key, value 
FROM aggregates 
WHERE type = 'global' 
ORDER BY key;
```

### Roles Table

Stores role definitions.

**Columns:**

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| `id` | VARCHAR(50) | No | Role identifier (Primary Key) |
| `name` | VARCHAR(100) | No | Display name |
| `description` | TEXT | Yes | Role description |
| `hidden` | BOOLEAN | No | Hide from leaderboard (default: false) |
| `created_at` | TIMESTAMP | No | Role creation time |

**Indexes:**
- Primary key on `id`
- Index on `hidden`

**Example:**

```sql
SELECT * FROM roles WHERE hidden = false ORDER BY name;
```

## Data Types

### Contributor

```typescript
interface Contributor {
  username: string;
  name: string;
  avatar_url?: string;
  role: string;
  socials?: {
    github?: string;
    linkedin?: string;
    twitter?: string;
    email?: string;
    [key: string]: string | undefined;
  };
  created_at: Date;
  updated_at: Date;
}
```

### Activity

```typescript
interface Activity {
  id: string;
  username: string;
  activity_type: string;
  timestamp: Date;
  points: number;
  metadata?: {
    repository?: string;
    pr_number?: number;
    issue_number?: number;
    title?: string;
    url?: string;
    [key: string]: any;
  };
  created_at: Date;
}
```

### Aggregate

```typescript
interface Aggregate {
  id: number;
  type: 'global' | 'contributor';
  key: string;
  value: number;
  metadata?: {
    [key: string]: any;
  };
  updated_at: Date;
}
```

### Role

```typescript
interface Role {
  id: string;
  name: string;
  description?: string;
  hidden: boolean;
  created_at: Date;
}
```

## Common Queries

### Top Contributors by Points

```sql
SELECT 
  c.username,
  c.name,
  c.avatar_url,
  c.role,
  SUM(a.points) as total_points
FROM contributors c
JOIN activities a ON c.username = a.username
WHERE c.role != 'bot'
  AND a.timestamp >= NOW() - INTERVAL '7 days'
GROUP BY c.username, c.name, c.avatar_url, c.role
ORDER BY total_points DESC
LIMIT 10;
```

### Activity Breakdown by Type

```sql
SELECT 
  activity_type,
  COUNT(*) as count,
  SUM(points) as total_points,
  AVG(points) as avg_points
FROM activities
WHERE timestamp >= NOW() - INTERVAL '30 days'
GROUP BY activity_type
ORDER BY total_points DESC;
```

### Contributor Activity Timeline

```sql
SELECT 
  DATE_TRUNC('day', timestamp) as date,
  activity_type,
  COUNT(*) as count,
  SUM(points) as points
FROM activities
WHERE username = 'johndoe'
  AND timestamp >= NOW() - INTERVAL '90 days'
GROUP BY DATE_TRUNC('day', timestamp), activity_type
ORDER BY date DESC, activity_type;
```

### Role Distribution

```sql
SELECT 
  r.name as role_name,
  COUNT(c.username) as contributor_count
FROM roles r
LEFT JOIN contributors c ON r.id = c.role
WHERE r.hidden = false
GROUP BY r.id, r.name
ORDER BY contributor_count DESC;
```

## Helper Functions

### Database Connection

```typescript
import { getDb } from '@/lib/db';

// Get database instance
const db = getDb();

// Execute query
const result = await db.query('SELECT * FROM contributors LIMIT 10');
```

### Configuration

```typescript
import { getConfig } from '@/lib/config';

// Get configuration
const config = getConfig();

// Access values
const orgName = config.org.name;
const roles = config.leaderboard.roles;
```

### Utilities

```typescript
import { cn } from '@/lib/utils';

// Combine class names
const className = cn('base-class', condition && 'conditional-class');
```

## Environment Variables

### Build Time

Required during build:

| Variable | Description | Example |
|----------|-------------|---------|
| `PGLITE_DB_PATH` | Path to database directory | `../pglite-data` |
| `LEADERBOARD_DATA_PATH` | Path to data source | `../leaderboard-data` |
| `NODE_ENV` | Environment mode | `production` |

### Runtime (Scrapers)

Required for scrapers:

| Variable | Description | Required For |
|----------|-------------|--------------|
| `GITHUB_TOKEN` | GitHub API token | GitHub scraper |
| `GITHUB_ORG` | GitHub organization | GitHub scraper |
| `SLACK_API_TOKEN` | Slack API token | Slack scraper |
| `SLACK_CHANNEL` | Slack channel ID | Slack scraper |

## Scripts Reference

### Database Scripts

| Script | Description | Usage |
|--------|-------------|-------|
| `db:prepare` | Initialize database schema | `pnpm db:prepare` |
| `db:import` | Import data from source | `pnpm db:import` |
| `db:export` | Export database to JSON | `pnpm db:export` |
| `db:exec` | Execute SQL via stdin | `echo "SQL" \| pnpm db:exec` |

### Build Scripts

| Script | Description | Usage |
|--------|-------------|-------|
| `dev` | Start development server | `pnpm dev` |
| `build` | Build for production | `pnpm build` |
| `start` | Start production server | `pnpm start` |
| `prebuild` | Run before build | Automatic |

### Test Scripts

| Script | Description | Usage |
|--------|-------------|-------|
| `test` | Run tests once | `pnpm test` |
| `test:watch` | Run tests in watch mode | `pnpm test:watch` |
| `test:ui` | Run tests with UI | `pnpm test:ui` |
| `test:coverage` | Generate coverage report | `pnpm test:coverage` |

### Utility Scripts

| Script | Description | Usage |
|--------|-------------|-------|
| `lint` | Run linter | `pnpm lint` |
| `generate:workflow` | Generate GitHub workflow | `pnpm generate:workflow` |

## File Structure

```
leaderboard/
├── app/                    # Next.js app directory
│   ├── [username]/        # Dynamic contributor pages
│   ├── docs/              # Documentation pages
│   ├── leaderboard/       # Leaderboard pages
│   ├── people/            # People page
│   ├── layout.tsx         # Root layout
│   └── page.tsx           # Home page
├── components/            # React components
│   ├── docs/             # Documentation components
│   └── ui/               # UI components
├── lib/                   # Library code
│   ├── config.ts         # Configuration loader
│   ├── db.ts             # Database utilities
│   └── utils.ts          # Utility functions
├── public/                # Static assets
├── scripts/               # Build and utility scripts
├── tests/                 # Test files
├── types/                 # TypeScript type definitions
├── config.yaml            # Configuration file
├── config.schema.json     # Configuration schema
├── next.config.ts         # Next.js configuration
├── package.json           # Dependencies
└── tsconfig.json          # TypeScript configuration
```

## Support

For more information:

- [View configuration reference](/docs/configuration-reference)
- [Learn about data management](/docs/data-management)
- [Read troubleshooting guide](/docs/troubleshooting)
- [GitHub Issues](https://github.com/ohcnetwork/leaderboard/issues)

